# simple-ical-server

[![Test](https://github.com/lks-hrsch/simple-ical-server/actions/workflows/test.yml/badge.svg)](https://github.com/lks-hrsch/simple-ical-server/actions/workflows/test.yml)
[![codecov](https://codecov.io/gh/lks-hrsch/simple-ical-server/graph/badge.svg)](https://codecov.io/gh/lks-hrsch/simple-ical-server)
[![Build](https://github.com/lks-hrsch/simple-ical-server/actions/workflows/build.yml/badge.svg)](https://github.com/lks-hrsch/simple-ical-server/actions/workflows/build.yml)
[![License: AGPL v3](https://img.shields.io/badge/License-AGPL%20v3-blue.svg)](https://www.gnu.org/licenses/agpl-3.0)

> [!IMPORTANT]
> **AI Generation Disclaimer**: This entire project, including its code, configuration, and documentation, was generated by an AI assistant in response to user requirements.

A lightweight Python server built with **FastAPI** that dynamically generates and serves iCal (`.ics`) files from `.csv` data files.

## Features

- **Automatic Geocoding**: Resolves addresses to coordinates using **OpenStreetMap (Nominatim)**.
- **Structured Locations**: Adds `GEO` and `X-APPLE-STRUCTURED-LOCATION` for one-tap map navigation in iOS/macOS/Android calendars.
- **Privacy Controls**: Includes a global geocoding kill switch and dynamic `User-Agent` management.
- **Dynamic iCal Generation**: Automatically converts CSV files in the `data/` directory to standard iCal format.
- **All-Day Events**: Supports all-day events by setting the duration to `1d` or `2d` (ignores the time column).
- **Timezone Awareness**: Supports localized event times (default: `Europe/Berlin`) using `pytz`.
- **Modern Toolchain**: 
  - Managed with [uv](https://github.com/astral-sh/uv) for high-performance dependency management.
  - Reproducible development environments with [Nix Flakes](https://nixos.org/) and `uv2nix`.
  - Pinned to **Python 3.13**.
  - Configuration via **Pydantic Settings** (supports `.env` files and environment variables).
- **CI/CD Driven**:
  - **GitHub Actions**: Automated testing and linting via Nix on every push.
  - **Docker Ready**: Multi-arch builds (`amd64`, `arm64`) triggered by version tags.
- **Repository Standards**:
  - **License**: Licensed under the **GNU Affero General Public License v3.0**.
  - **Code Ownership**: Defined `.github/CODEOWNERS`.
- **Health Checks**: `/healthz` and `/readyz` endpoints for monitoring.

## Getting Started

### Prerequisites

- [uv](https://github.com/astral-sh/uv)
- (Optional) [Nix](https://nixos.org/) for the development shell.

### Development with Nix

```bash
# This will set up a virtualenv in .venv and provide uv, ruff, etc.
nix develop
```

### Manual Setup with uv

```bash
uv sync
```

### Running the Server

```bash
uv run uvicorn src.main:app --reload
```

## API Endpoints

- `GET /`: Lists all available calendars (CSV files in `data/`).
- `GET /{name}.ics`: Serves the generated iCal file for the specified calendar.
- `GET /healthz`: Liveness check.
- `GET /readyz`: Readiness check.

## Data Format

CSV files should be placed in the `data/` directory. The filename becomes the calendar name.

**Format Example (`events.csv`):**
```csv
date,time,duration,location_name,location,place,name,description,timezone
11.04.2026,09:00,8h,Bäckerei Musterstadt,Musterstraße 123 12345 Musterstadt,Germany,Frühstücks-Spezial,Leckere Croissants für alle!,Europe/Berlin
12.05.2024,00:00,1d,,Schlossgarten,Germany,Feiertag,Ein ganzer Tag Entspannung,Europe/Berlin
```

- `date`: `%d.%m.%Y`
- `time`: `%H:%M` (ignored for all-day events)
- `duration`: e.g., `30min`, `1h`, `1d`, `2d`
- `location_name`: Optional explicit venue name (e.g., "Bäckerei"). Falls back to `name` if empty.
- `location`: Street and ZIP/City.
- `place`: Optional (defaults to `DEFAULT_PLACE`, e.g., "Germany").
- `timezone`: Optional (defaults to `TZ` setting or `Europe/Berlin`)

## Configuration

The application uses **Pydantic Settings**. You can configure it via environment variables or a `.env` file:

- `TZ`: The default timezone for events (default: `Europe/Berlin`).
- `DATA_DIR`: The directory containing CSV files (default: `data`).
- `DEFAULT_PLACE`: Default country/region appended to addresses for geocoding accuracy (default: `Germany`).
- `GEOCODE_ENABLED`: Set to `False` to disable all external network calls for geocoding (default: `True`).

### Running Tests

Run tests with `pytest` (manually or via pre-commit):

```bash
uv run pytest
# OR using Nix
nix develop --command pytest
```

### Linting and Formatting

The project uses [Ruff](https://github.com/astral-sh/ruff) for linting and formatting, managed via Nix.
Pre-commit hooks are automatically installed when using `nix develop`.

```bash
nix develop --command ruff check .
nix develop --command ruff format .
```

## License

This project is licensed under the **GNU Affero General Public License v3.0**. See the [LICENSE](LICENSE) file for details.

## Docker

### Docker Compose (Recommended)

Run the server with the `data/` directory mounted as a volume. By default, it will attempt to use the pre-built image from GHCR:

```bash
docker compose up
```

Alternatively, to build it locally:
```bash
docker compose up --build
```

This allows you to update CSV files in `data/` without rebuilding the image.

### Direct Docker Run

You can pull and run the image directly from GHCR:

```bash
docker pull ghcr.io/lks-hrsch/simple-ical-server:latest
docker run -p 8000:8000 -v $(pwd)/data:/app/data ghcr.io/lks-hrsch/simple-ical-server:latest
```
